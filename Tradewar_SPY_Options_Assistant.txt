//@version=5
indicator("Tradewar SPY Options Assistant", overlay=true)

// ================= INPUTS =================
enableCalls    = input.bool(true, "Enable CALL Trades")
enablePuts     = input.bool(false, "Enable PUT Trades")
enableScaleIn  = input.bool(true, "Enable Scale-In (Add)")
maxAdds        = input.int(1, "Max Adds", minval=0, maxval=2)

expDate = input.string("DEC-19-25", "Expiration")

callStrike = input.int(684, "CALL Strike Price")
callTarget = input.float(685.0, "CALL Target")
callLevel  = input.float(683.6, "CALL Resistance Level")

putStrike  = input.int(674, "PUT Strike Price")
putTarget  = input.float(672.5, "PUT Target")
putLevel   = input.float(674.8, "PUT Support Level")

emaFast = input.int(8, "EMA Fast")
emaSlow = input.int(21, "EMA Slow")
holdBars = input.int(2, "Hold Candles", minval=1)

atrLen        = input.int(14, "ATR Length")
atrMultiplier = input.float(1.5, "ATR Multiplier")

maxPullbackMinutes = input.int(30, "Max VWAP Pullback Minutes")
acceptCooldownBars = input.int(5, "VWAP Acceptance Cooldown (Bars)", minval=0)

// ================= SESSION =================
inSession = not na(time(timeframe.period, session.regular))

// ================= STATE =================
var bool   inTrade = false
var string side    = ""
var float  entry   = na
var float  stopPx  = na
var int    addCount = 0
var int    lastAddBar = na
var int    lastExitBar = na

// ================= INDICATORS =================
emaFastV = ta.ema(close, emaFast)
emaSlowV = ta.ema(close, emaSlow)
vwapV    = ta.vwap(hlc3)
atrValue = ta.atr(atrLen)

// ================= TREND =================
bullTrend = emaFastV > emaSlowV and close > vwapV
bearTrend = emaFastV < emaSlowV and close < vwapV

// ================= VWAP ACCEPTANCE MEMORY =================
barsPerMinute = timeframe.isminutes ? timeframe.multiplier : 1
maxPullbackBars = math.max(1, math.round(maxPullbackMinutes / barsPerMinute))

var bool vwapAcceptedCall = false
var bool vwapAcceptedPut  = false
var int  vwapAcceptBarCall = na
var int  vwapAcceptBarPut  = na

canAccept = na(lastExitBar) or bar_index - lastExitBar > acceptCooldownBars
canAcceptCall = canAccept and emaFastV > emaSlowV
canAcceptPut  = canAccept and emaFastV < emaSlowV

if inSession and not inTrade and canAcceptCall and bullTrend and close > vwapV and not vwapAcceptedCall
    vwapAcceptedCall := true
    vwapAcceptBarCall := bar_index

if inSession and not inTrade and canAcceptPut and bearTrend and close < vwapV and not vwapAcceptedPut
    vwapAcceptedPut := true
    vwapAcceptBarPut := bar_index

if vwapAcceptedCall and bar_index - vwapAcceptBarCall > maxPullbackBars
    vwapAcceptedCall := false

if vwapAcceptedPut and bar_index - vwapAcceptBarPut > maxPullbackBars
    vwapAcceptedPut := false

if close < vwapV
    vwapAcceptedCall := false

if close > vwapV
    vwapAcceptedPut := false

// ================= VWAP RECLAIM =================
callReclaim = inSession and vwapAcceptedCall and bar_index > vwapAcceptBarCall and close > vwapV and low <= vwapV
putReclaim  = inSession and vwapAcceptedPut  and bar_index > vwapAcceptBarPut  and close < vwapV and high >= vwapV

// ================= DAILY RESET =================
if ta.change(time("D")) != 0
    inTrade := false
    side := ""
    entry := na
    stopPx := na
    addCount := 0
    lastAddBar := na
    lastExitBar := na
    vwapAcceptedCall := false
    vwapAcceptedPut  := false

// ================= HOLD =================
var int callHold = 0
var int putHold  = 0

callHold := not inTrade and close > callLevel and close > vwapV ? callHold + 1 : 0
putHold  := not inTrade and close < putLevel  and close < vwapV ? putHold  + 1 : 0

// ================= ENTRY =================
callEntry = inSession and enableCalls and not inTrade and callHold >= holdBars and callReclaim
putEntry  = inSession and enablePuts  and not inTrade and putHold  >= holdBars and putReclaim

if callEntry
    inTrade := true
    side := "CALL"
    entry := close
    stopPx := close - atrMultiplier * atrValue
    addCount := 0
    lastAddBar := na
    vwapAcceptedCall := false
    vwapAcceptedPut  := false
    callHold := 0
    putHold := 0
    alert("ðŸ“ˆ CONFIRMED CALL ENTRY | Strike $" + str.tostring(callStrike) + " | Target $" + str.tostring(callTarget) + " | EXP " + expDate, alert.freq_once_per_bar_close)

if putEntry
    inTrade := true
    side := "PUT"
    entry := close
    stopPx := close + atrMultiplier * atrValue
    addCount := 0
    lastAddBar := na
    vwapAcceptedCall := false
    vwapAcceptedPut  := false
    callHold := 0
    putHold := 0
    alert("ðŸ“‰ CONFIRMED PUT ENTRY | Strike $" + str.tostring(putStrike) + " | Target $" + str.tostring(putTarget) + " | EXP " + expDate, alert.freq_once_per_bar_close)

// ================= SAFE SCALE-IN =================
scaleInCall = enableScaleIn and inTrade and side == "CALL" and addCount < maxAdds and vwapAcceptedCall and close > vwapV and low <= vwapV and close >= entry and low > stopPx and bar_index != lastAddBar
scaleInPut  = enableScaleIn and inTrade and side == "PUT" and addCount < maxAdds and vwapAcceptedPut and close < vwapV and high >= vwapV and close <= entry and high < stopPx and bar_index != lastAddBar

if scaleInCall
    addCount += 1
    lastAddBar := bar_index
    stopPx := math.max(stopPx, entry - atrMultiplier * atrValue)
    alert("âž• ADD ON VWAP HOLD | SPY CALL | Add #" + str.tostring(addCount) + " | EXP " + expDate, alert.freq_once_per_bar_close)

if scaleInPut
    addCount += 1
    lastAddBar := bar_index
    stopPx := math.min(stopPx, entry + atrMultiplier * atrValue)
    alert("âž• ADD ON VWAP HOLD | SPY PUT | Add #" + str.tostring(addCount) + " | EXP " + expDate, alert.freq_once_per_bar_close)

// ================= STOP =================
stopHit = inSession and inTrade and ((side == "CALL" and low <= stopPx) or (side == "PUT" and high >= stopPx))

if stopHit
    float hitStop = stopPx
    inTrade := false
    side := ""
    stopPx := na
    lastAddBar := na
    lastExitBar := bar_index
    vwapAcceptedCall := false
    vwapAcceptedPut  := false
    alert("ðŸ›‘ STOP HIT | SPY | Stop $" + str.tostring(hitStop) + " | EXP " + expDate, alert.freq_once_per_bar)

// ================= TARGET =================
targetHit = inSession and inTrade and ((side == "CALL" and high >= callTarget) or (side == "PUT" and low <= putTarget))

if targetHit
    float hitTarget = side == "CALL" ? callTarget : putTarget
    inTrade := false
    side := ""
    stopPx := na
    lastAddBar := na
    lastExitBar := bar_index
    vwapAcceptedCall := false
    vwapAcceptedPut  := false
    alert("ðŸŽ¯ TARGET HIT | SPY | Target $" + str.tostring(hitTarget) + " | EXP " + expDate, alert.freq_once_per_bar)

// ================= PLOTS =================
plot(vwapV, "VWAP", color=color.blue)
plot(inTrade ? stopPx : na, "Stop", color=color.new(color.orange, 0), linewidth=2)
plot(side == "CALL" and inTrade ? callLevel : na, "CALL Level", color=color.green, linewidth=2)
plot(side == "PUT"  and inTrade ? putLevel  : na, "PUT Level",  color=color.red, linewidth=2)
plot(side == "CALL" and inTrade ? callTarget : na, "CALL Target", color=color.black)
plot(side == "PUT"  and inTrade ? putTarget  : na, "PUT Target",  color=color.black)
